<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s an IT blog..."/>
  <meta name="keyword" content="IT blog,Blog"/>
  <link rel="shortcut icon" href="/assets/img/avatar/logo_cs.png"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/css/highlight.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/css/widget.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/css/rocket.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/css/signature.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/css/catalog.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/css/wave.css"/>
      <!-- wave end -->
    

    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/css/gitalk.css"/>
      <!-- gitalk end -->
    

  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="http://yoursite-url/微服务架构中10个常用的设计模式/">
  <title>
    
      微服务架构中10个常用的设计模式 - Do or Die
    
  </title>
<meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'your-community/your-room'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Chase&#39;s Blog</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">首页</a>
          </li>

          
          
          
          
          <li>
            <a href="/categories/">
              
              分类
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              标签
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              归档
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>搜索</a>
          </li>
          

          <!-- LangSelect -->
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <!-- CDN: jsdelivr start -->
  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/assets/img/header_img/home_bg.jpg');
      --intro-header-background-image-url-post: url('https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/assets/img/header_img/post_bg.jpg');
      --intro-header-background-image-url-page: url('https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/assets/img/header_img/archive_bg.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/assets/img/header_img/home_bg.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/assets/img/header_img/post_bg.jpg');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/assets/img/header_img/archive_bg.jpg');
    }
    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr'); */
      
    }

    
  </style>
  <!-- CDN: jsdelivr end -->





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
            </div>
            <h1>微服务架构中10个常用的设计模式</h1>
            <h2 class="subheading"></h2>
            <span class="meta">
              Posted by Chase Shen on
              2023-04-29
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">23</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">6.8k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <p>从软件开发早期（1960 年代）开始，应对大型软件系统中的复杂性一直是一项令人生畏的任务。多年来为了应对软件系统的复杂性，软件工程师和架构师们做了许多尝试：David Parnas 的模块化和封装 （1972）， Edsger W. Dijkstra （1974）的关注点分离以及 SOA（1988）。</p>
<p>他们都是使用分而治之这项成熟的传统技术来应对大型系统的复杂性。自 2010 年开始，这些技术被证实无法继续应对 Web 级应用或者现代大型企业级应用的复杂性。因此架构师和工程师们发展出了一种全新的现代方式来解决这个问题，就是微服务架构。它虽然延续了分而治之的思想，但却是以全新的方式来实现的。</p>
<p>软件设计模式是解决软件设计中常见问题的通用、可复用的解决方案。设计模式让我们可以分享通用词汇并使用经实战检验的方案，以免重复造轮子。我先简单介绍下微服务架构。</p>
<p>通过阅读这篇文章，你会学到：</p>
<ul>
<li>微服务架构</li>
<li>微服务架构的优势</li>
<li>微服务架构的劣势</li>
<li>何时使用微服务架构</li>
</ul>
<p>最重要的微服务架构设计模式，包括其优缺点、用例、上下文、技术栈示例及可用资源。</p>
<blockquote>
<p>请注意，本清单中的大部分设计模式常出现在多种语境中，并且可以在非微服务架构中使用。而我将在微服务这个特定语境中介绍它们。</p>
</blockquote>
<h1>微服务架构</h1>
<p>那到底什么是微服务架构？有很多种定义方法。我的定义是这这样的：</p>
<p>微服务架构指的是将大型复杂系统按功能或者业务需求垂直切分成更小的子系统，这些子系统以独立部署的子进程存在，它们之间通过轻量级的、跨语言的同步（比如 REST，gRPC）或者异步（消息）网络调用进行通信。</p>
<p>下面是基于微服务架构的商业 Web 应用的组件视图：<br>
<img src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr@latest/post-assets/微服务架构中10个常用的设计模式/image.png" alt=""></p>
<h2 id="微服务架构的重要特征">微服务架构的重要特征</h2>
<ul>
<li>整个应用程序被拆分成相互独立但包含多个内部模块的子进程</li>
<li>与模块化的单体应用（Modular Monoliths）或 SOA 相反，微服务应用程序根据业务范围或领域垂直拆分。</li>
<li>微服务边界是外部的，微服务之间通过网络调用（RPC 或消息）相互通信。</li>
<li>微服务是独立的进程，它们可以独立部署。</li>
<li>它们以轻量级的方式进行通信，不需要任何智能通信通道。</li>
</ul>
<h2 id="微服务架构的优点">微服务架构的优点</h2>
<ul>
<li>更好的开发规模</li>
<li>更快的开发速度</li>
<li>支持迭代开发或现代化增量开发</li>
<li>充分利用现代软件开发生态系统的优势（云、容器、 DevOps、Serverless）</li>
<li>支持水平缩放和细粒度缩放</li>
<li>小体量，较低了开发人员的认知复杂性</li>
</ul>
<h2 id="微服务架构的缺点">微服务架构的缺点</h2>
<ul>
<li>更高数量级的活动组件（服务、数据库、进程、容器、框架）</li>
<li>复杂性从代码转移到基础设施</li>
<li>RPC 调用和网络通信的大量增加</li>
<li>整个系统的安全性管理更具有挑战性</li>
<li>整个系统的设计变得更加困难</li>
<li>引入了分布式系统的复杂性</li>
</ul>
<h2 id="何时使用微服务架构">何时使用微服务架构</h2>
<ul>
<li>大规模 Web 应用开发</li>
<li>跨团队企业级应用协作开发</li>
<li>长期收益优先于短期收益</li>
<li>团队拥有能够设计微服务架构的软件架构师或高级工程师</li>
</ul>
<h1>微服务架构的设计模式</h1>
<h2 id="独享数据库（Database-per-Microservice）">独享数据库（Database per Microservice）</h2>
<p>当一家公司将大型单体系统替换成一组微服务，首先要面临的最重要决策是关于数据库。单体架构会使用大型中央数据库。即使转移到微服务架构许多架构师仍倾向于保持数据库不变。虽然有一些短期收益，但它却是反模式的，特别是在大规模系统中，微服务将在数据库层严重耦合，整个迁移到微服务的目标都将面临失败（例如，团队授权、独立开发等问题）。</p>
<p>更好的方法是为每个微服务提供自己的数据存储，这样服务之间在数据库层就不存在强耦合。这里我使用数据库这一术语来表示逻辑上的数据隔离，也就是说微服务可以共享物理数据库，但应该使用分开的数据结构、集合或者表，这还将有助于确保微服务是按照领域驱动设计的方法正确拆分的。</p>
<img src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr@latest/post-assets/微服务架构中10个常用的设计模式/image2.png" alt="">
<h3 id="优点">优点</h3>
<ul>
<li>数据由服务完全所有</li>
<li>服务的开发团队之间耦合度降低</li>
</ul>
<h3 id="缺点">缺点</h3>
<ul>
<li>服务间的数据共享变得更有挑战性</li>
<li>在应用范围的保证 ACID 事务变得困难许多</li>
<li>细心设计如何拆分单体数据库是一项极具挑战的任务</li>
</ul>
<h3 id="何时使用独享数据库">何时使用独享数据库</h3>
<ul>
<li>在大型企业应用程序中</li>
<li>当团队需要完全把控微服务以实现开发规模扩展和速度提升</li>
</ul>
<h3 id="何时不宜使用独享数据库">何时不宜使用独享数据库</h3>
<ul>
<li>在小规模应用中</li>
<li>如果是单个团队开发所有微服务</li>
</ul>
<h3 id="可用技术示例">可用技术示例</h3>
<ul>
<li>所有 SQL、 NoSQL 数据库都提供数据的逻辑分离（例如，单独的表、集合、结构、数据库）。</li>
</ul>
<h2 id="事件源（Event-Sourcing）">事件源（Event Sourcing）</h2>
<p>在微服务架构中，特别使用独享数据库时，微服务之间需要进行数据交换。对于弹性高可伸缩的和可容错的系统，它们应该通过交换事件进行异步通信。在这种情况，您可能希望进行类似更新数据库并发送消息这样的原子操作，如果在大数据量的分布式场景使用关系数据库，您将无法使用两阶段锁协议（2PL），因为它无法伸缩。而 NoSQL 数据库因为大多不支持两阶段锁协议甚至无法实现分布式事务。</p>
<p>在这些场景，可以基于事件的架构使用事件源模式。在传统数据库中，直接存储的是业务实体的当前“状态”，而在事件源中任何“状态”更新事件或其他重要事件都会被存储起来，而不是直接存储实体本身。这意味着业务实体的所有更改将被保存为一系列不可变的事件。因为数据是作为一系列事件存储的，而非直接更新存储，所以各项服务可以通过重放事件存储中的事件来计算出所需的数据状态。</p>
<img src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr@latest/post-assets/微服务架构中10个常用的设计模式/image3.png" alt="">
<h3 id="优点-2">优点</h3>
<ul>
<li>为高可伸缩系统提供原子性操作</li>
<li>自动记录实体变更历史，包括时序回溯功能</li>
<li>松耦合和事件驱动的微服务</li>
</ul>
<h3 id="缺点-2">缺点</h3>
<ul>
<li>从事件存储中读取实体成为新的挑战，通常需要额外的数据存储（CQRS 模式）。</li>
<li>系统整体复杂性增加了，通常需要领域驱动设计。</li>
<li>系统需要处理事件重复（幂等）或丢失</li>
<li>变更事件结构成为新的挑战。</li>
</ul>
<h3 id="何时使用事件源">何时使用事件源</h3>
<ul>
<li>使用关系数据库的、高可伸缩的事务型系统</li>
<li>使用 NoSQL 数据库的事务型系统</li>
<li>弹性高可伸缩微服务架构</li>
<li>典型的消息驱动或事件驱动系统（电子商务、预订和预约系统）</li>
</ul>
<h3 id="何时不宜使用事件源">何时不宜使用事件源</h3>
<ul>
<li>使用 SQL 数据库的低可伸缩性事务型系统</li>
<li>在服务可以同步交换数据（例如，通过 API）的简单微服务架构中。</li>
</ul>
<h3 id="可用技术示例-2">可用技术示例</h3>
<ul>
<li>事件存储：EventStoreDB、Apache Kafka、Confluent Cloud、AWS Kinesis、Azure Event Hub、GCP Pub/Sub、Azure Cosmos DB、MongoDB、Cassandra、Amazon DynamoDB</li>
<li>框架：Lagom、Akka、Spring、akkatecture、Axon、Eventuate</li>
</ul>
<h2 id="命令和查询职责分离（CQRS）">命令和查询职责分离（CQRS）</h2>
<p>如果我们使用事件源，那么从事件存储中读取数据就变得困难了。要从数据存储中获取实体，我们需要处理所有的实体事件。有时我们对读写操作还会有不同的一致性和吞吐量要求。</p>
<p>这种情况，我们可以使用 CQRS 模式。在该模式中，系统的数据修改部分（命令）与数据读取部分（查询）是分离的。而 CQRS 模式有两种容易令人混淆的模式，分别是简单的和高级的。</p>
<p>在其简单形式中，不同实体或 ORM 模型被用于读写操作，如下所示：</p>
<img src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr@latest/post-assets/微服务架构中10个常用的设计模式/CQRS" alt="(simple).png ">
<p>它有助于强化单一职责原则和分离关注点，从而实现更简洁的设计。</p>
<p>在其高级形式中，会有不同的数据存储用于读写操作。高级的 CQRS 通常结合事件源模式。根据不同情况，会使用不同类型的写数据存储和读数据存储。写数据存储是“记录的系统”，也就是整个系统的核心源头。</p>
<img src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr@latest/post-assets/微服务架构中10个常用的设计模式/CQRS" alt="(advanced).png ">
<p>对于读频繁的应用程序或微服务架构，OLTP 数据库（任何提供 ACID 事务保证的关系或非关系数据库）或分布式消息系统都可以被用作写存储。对于写频繁的应用程序（写操作高可伸缩性和大吞吐量），需要使用写可水平伸缩的数据库（如全球托管的公共云数据库）。标准化的数据则保存在写数据存储中。</p>
<p>对搜索（例如 Apache Solr、Elasticsearch）或读操作（KV 数据库、文档数据库）进行优化的非关系数据库常被用作读存储。许多情况会在需要 SQL 查询的地方使用读可伸缩的关系数据库。非标准化和特殊优化过的数据则保存在读存储中。</p>
<p>数据是从写存储异步复制到读存储中的，所以读存储和写存储之间会有延迟，但最终是一致的。</p>
<h3 id="优点-3">优点</h3>
<ul>
<li>在事件驱动的微服务中数据读取速度更快</li>
<li>数据的高可用性</li>
<li>读写系统可独立扩展</li>
</ul>
<h3 id="缺点-3">缺点</h3>
<ul>
<li>读数据存储是弱一致性的（最终一致性）</li>
<li>整个系统的复杂性增加了，混乱的 CQRS 会显着危害整个项目。</li>
</ul>
<h3 id="何时使用-CQRS">何时使用 CQRS</h3>
<ul>
<li>在高可扩展的微服务架构中使用事件源</li>
<li>在复杂领域模型中，读操作需要同时查询多个数据存储。</li>
<li>在读写操作负载差异明显的系统中</li>
</ul>
<h3 id="何时不宜使用-CQRS">何时不宜使用 CQRS</h3>
<ul>
<li>在没有必要存储大量事件的微服务架构中，用事件存储快照来计算实体状态是一个更好的选择。</li>
<li>在读写操作负载相近的系统中。</li>
</ul>
<h3 id="可用技术示例-3">可用技术示例</h3>
<ul>
<li>写存储：EventStoreDB， Apache Kafka， Confluent Cloud， AWS Kinesis， Azure Event Hub， GCP Pub/Sub， Azure Cosmos DB， MongoDB， Cassandra. Amazon DynamoDB</li>
<li>读存储：Elastic Search， Solr， Cloud Spanner， Amazon Aurora， Azure Cosmos DB， Neo4j</li>
<li>框架：Lagom， Akka， Spring， akkatecture， Axon， Eventuate</li>
</ul>
<h2 id="Saga">Saga</h2>
<p>如果微服务使用独享数据库，那么通过分布式事务管理一致性是一个巨大的挑战。你无法使用传统的两阶段提交协议，因为它要么不可伸缩（关系数据库），要么不被支持（多数非关系数据库）。</p>
<p>但您还是可以在微服务架构中使用 Saga 模式实现分布式事务。Saga 是 1987 年开发的一种古老模式，是关系数据库中关于大事务的一个替代概念。但这种模式的一种现代变种对分布式事务也非常有效。Saga 模式是一个本地事务序列，其每个事务在一个单独的微服务内更新数据存储并发布一个事件或消息。<br>
Saga 中的首个事务是由外部请求（事件或动作）初始化的，一旦本地事务完成（数据已保存在数据存储且消息或事件已发布），那么发布的消息或事件则会触发 Saga 中的下一个本地事务。</p>
<img src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr@latest/post-assets/微服务架构中10个常用的设计模式/saga.png" alt="">
<p>如果本地事务失败，Saga 将执行一系列补偿事务来回滚前面本地事务的更改。<br>
Saga 事务协调管理主要有两种形式：</p>
<p>事件编排 Choreography：分散协调，每个微服务生产并监听其他微服务的事件或消息然后决定是否执行某个动作。<br>
命令编排 Orchestration：集中协调，由一个协调器告诉参与的微服务哪个本地事务需要执行。</p>
<h3 id="优点-4">优点</h3>
<ul>
<li>为高可伸缩或松耦合的、事件驱动的微服务架构提供一致性事务。</li>
<li>为使用了不支持 2PC 的非关系数据库的微服务架构提供一致性事务。</li>
</ul>
<h3 id="缺点-4">缺点</h3>
<ul>
<li>需要处理瞬时故障，并且提供等幂性。</li>
<li>难以调试，而且复杂性随着微服务数量增加而增加。</li>
</ul>
<h3 id="何时使用-Saga">何时使用 Saga</h3>
<ul>
<li>在使用了事件源的高可伸缩、松耦合的微服务中。</li>
<li>在使用了分布式非关系数据库的系统中。</li>
</ul>
<h3 id="何时不宜使用-Saga">何时不宜使用 Saga</h3>
<ul>
<li>使用关系数据库的低可伸缩性事务型系统。</li>
<li>在服务间存在循环依赖的系统中。</li>
</ul>
<h3 id="可用技术示例-4">可用技术示例</h3>
<ul>
<li>Axon， Eventuate， Narayana</li>
</ul>
<h2 id="面向前端的后端-（BFF）">面向前端的后端 （BFF）</h2>
<p>在现代商业应用开发，特别是微服务架构中，前后端应用是分离和独立的服务，它们通过 API 或 GraphQL 连接。如果应用程序还有移动 App 客户端，那么 Web 端和移动客户端使用相同的后端微服务就会出现问题。因为移动客户端和 Web 客户端有不同的屏幕尺寸、显示屏、性能、能耗和网络带宽，它们的 API 需求不同。</p>
<p>面向前端的后端模式适用于需要为特殊 UI 定制单独后端的场景。它还提供了其他优势，比如作为下游微服务的封装，从而减少 UI 和下游微服务之间的频繁通信。此外，在高安全要求的场景中，BFF 为部署在 DMZ 网络中的下游微服务提供了更高的安全性。</p>
<img src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr@latest/post-assets/微服务架构中10个常用的设计模式/image7.png" alt="">
<h3 id="优点-5">优点</h3>
<ul>
<li>分离 BFF 之间的关注点，使得我们可以为具体的 UI 优化他们。</li>
<li>提供更高的安全性</li>
<li>减少 UI 和下游微服务之间频繁的通信</li>
</ul>
<h3 id="缺点-5">缺点</h3>
<ul>
<li>BFF 之间代码重复</li>
<li>大量的 BFF 用于其他用户界面（例如，智能电视，Web，移动端，PC 桌面版）</li>
<li>需要仔细的设计和实现，BFF 不应该包含任何业务逻辑，而应只包含特定客户端逻辑和行为。</li>
</ul>
<h3 id="何时使用-BFF">何时使用 BFF</h3>
<ul>
<li>如果应用程序有多个含不同 API 需求的 UI</li>
<li>出于安全需要，UI 和下游微服务之间需要额外的层。</li>
<li>如果在 UI 开发中使用微前端。</li>
</ul>
<h3 id="何时不宜使用-BFF">何时不宜使用 BFF</h3>
<ul>
<li>如果应用程序虽有多个 UI，但使用的 API 相同。</li>
<li>如果核心微服务不是部署在 DMZ 网络中。</li>
</ul>
<h3 id="可用技术示例-5">可用技术示例</h3>
<ul>
<li>任何后端框架（Node.js，Spring，Django，Laravel，Flask，Play，…）都能支持。</li>
</ul>
<h2 id="API-网关">API 网关</h2>
<p>在微服务架构中，UI 通常连接多个微服务。如果微服务是细粒度的（FaaS） ，那么客户端可能需要连接非常多的微服务，这将变得繁杂和具有挑战性。此外，这些服务包括它们的 API 还将不断进化。大型企业还希望能有其他横切关注点（SSL 终止、身份验证、授权、节流、日志记录等）。</p>
<p>一个解决这些问题的可行方法是使用 API 网关。API 网关位于客户端 APP 和后端微服务之间充当 facade，它可以是反向代理，将客户端请求路由到适当的后端微服务。它还支持将客户端请求扇出到多个微服务，然后将响应聚合后返回给客户端。它还支持必要的横切关注点。</p>
<img src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr@latest/post-assets/微服务架构中10个常用的设计模式/image8.png" alt="">
<h3 id="优点-6">优点</h3>
<ul>
<li>在前端和后端服务之间提供松耦合</li>
<li>减少客户端和微服务之间的调用次数</li>
<li>通过 SSL 终端、身份验证和授权实现高安全性</li>
<li>集中管理的横切关注点，例如，日志记录和监视、节流、负载平衡。</li>
</ul>
<h3 id="缺点-6">缺点</h3>
<ul>
<li>可能导致微服务架构中的单点故障</li>
<li>额外的网络调用带来的延迟增加</li>
<li>如果不进行扩展，它们很容易成为整个企业应用的瓶颈。</li>
<li>额外的维护和开发费用</li>
</ul>
<h3 id="何时使用-API-网关">何时使用 API 网关</h3>
<ul>
<li>在复杂的微服务架构中，它几乎是必须的。</li>
<li>在大型企业中，API 网关是中心化安全性和横切关注点的必要工具。</li>
</ul>
<h3 id="何时不宜使用-API-网关">何时不宜使用 API 网关</h3>
<ul>
<li>在安全和集中管理不是最优先要素的私人项目或小公司中。</li>
<li>如果微服务的数量相当少。</li>
</ul>
<h3 id="可用技术示例-6">可用技术示例</h3>
<ul>
<li>Amazon API 网关， Azure API 管理， Apigee， Kong， WSO2 API 管理器</li>
</ul>
<h2 id="Strangler">Strangler</h2>
<p>如果想在运行中的项目中使用微服务架构，我们需要将遗留的或现有的单体应用迁移到微服务。将现有的大型在线单体应用程序迁移到微服务是相当有挑战性的，因为这可能破坏应用程序的可用性。</p>
<p>一个解决方案是使用 Strangler 模式。Strangler 模式意味着通过使用新的微服务逐步替换特定功能，将单体应用程序增量地迁移到微服务架构。此外，新功能只在微服务中添加，而不再添加到遗留的单体应用中。</p>
<p>然后配置一个 Facade （API 网关）来路由遗留单体应用和微服务间的请求。当某个功能从单体应用迁移到微服务，Facade 就会拦截客户端请求并路由到新的微服务。一旦迁移了所有的功能，遗留单体应用程序就会被“扼杀（Strangler）”，即退役。</p>
<img src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr@latest/post-assets/微服务架构中10个常用的设计模式/image9.png" alt="">
<h3 id="优点-7">优点</h3>
<ul>
<li>安全的迁移单体应用程序到微服务</li>
<li>可以并行地迁移已有功能和开发新功能</li>
<li>迁移过程可以更好把控节奏</li>
</ul>
<h3 id="缺点-7">缺点</h3>
<ul>
<li>在现有的单体应用服务和新的微服务之间共享数据存储变得具有挑战性</li>
<li>添加 Facade （API 网关）将增加系统延迟</li>
<li>端到端测试变得困难</li>
</ul>
<h3 id="何时使用-Strangler">何时使用 Strangler</h3>
<ul>
<li>将大型后端单体应用程序的增量迁移到微服务</li>
<li>何时不宜使用 Strangler</li>
<li>如果后端单体应用很小，那么全量替换会更好。</li>
<li>如果无法拦截客户端对遗留的单体应用程序的请求。</li>
</ul>
<h3 id="可用技术示例-7">可用技术示例</h3>
<ul>
<li>API 网关后端应用框架。</li>
</ul>
<h2 id="断路器">断路器</h2>
<p>在微服务架构中，微服务通过同步调用其他服务来满足业务需求。服务调用会由于瞬时故障（网络连接缓慢、超时或暂时不可用） 导致失败，这种情况重试可以解决问题。然而，如果出现了严重问题（微服务完全失败），那么微服务将长时间不可用，这时重试没有意义且浪费宝贵的资源（线程被阻塞，CPU 周期被浪费）。此外，一个服务的故障还会引发整个应用系统的级联故障。这时快速失败是一种更好的方法。</p>
<p>在这种情况，可以使用断路器模式挽救。一个微服务通过代理请求另一个微服务，其工作原理类似于电气断路器，代理通过统计最近发生的故障数量，并使用它来决定是继续请求还是简单的直接返回异常。</p>
<img src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr@latest/post-assets/微服务架构中10个常用的设计模式/image10.png" alt="">
<p>断路器可以有以下三种状态：</p>
<ul>
<li>关闭： 断路器将请求路由到微服务，并统计给定时段内的故障数量，如果超过阈值，它就会触发并进入打开状态。</li>
<li>打开： 来自微服务的请求会快速失败并返回异常。在超时后，断路器进入半开启状态。</li>
<li>半开： 只有有限数量的微服务请求被允许通过并进行调用。如果这些请求成功，断路器将进入闭合状态。如果任何请求失败，断路器则会进入开启状态。</li>
</ul>
<h3 id="优点-8">优点</h3>
<ul>
<li>提高微服务架构的容错性和弹性</li>
<li>阻止引发其他微服务的级联故障</li>
</ul>
<h3 id="缺点-8">缺点</h3>
<ul>
<li>需要复杂的异常处理</li>
<li>日志和监控</li>
<li>应该支持人工复位</li>
</ul>
<h3 id="何时使用断路器">何时使用断路器</h3>
<ul>
<li>在微服务间使用同步通信的紧耦合的微服务架构中</li>
<li>如果微服务依赖多个其他微服务</li>
</ul>
<h3 id="何时不宜使用断路器">何时不宜使用断路器</h3>
<ul>
<li>松耦合、事件驱动的微服务架构</li>
<li>如果微服务不依赖于其他微服务</li>
</ul>
<h3 id="可用技术示例-8">可用技术示例</h3>
<ul>
<li>API 网关，服务网格，各种断路器库（Hystrix， Reselience4J， Polly）。</li>
</ul>
<h2 id="外部化配置">外部化配置</h2>
<p>每个业务应用都有许多用于各种基础设施的配置参数（例如，数据库、网络、连接的服务地址、凭据、证书路径）。此外在企业应用程序通常部署在各种运行环境（Local、 Dev、 Prod）中，实现这些的一个方法是通过内部配置。这是一个致命糟糕实践，它会导致严重的安全风险，因为生产凭证很容易遭到破坏。此外，配置参数的任何更改都需要重新构建应用程序，这在在微服务架构中会更加严峻，因为我们可能拥有数百个服务。</p>
<p>更好的方法是将所有配置外部化，使得构建过程与运行环境分离，生产的配置文件只在运行时或通过环境变量使用，从而最小化了安全风险。</p>
<h3 id="优点-9">优点</h3>
<ul>
<li>生产配置不属于代码库，因而最小化了安全漏洞。</li>
<li>修改配置参数不需要重新构建应用程序。</li>
</ul>
<h3 id="缺点-9">缺点</h3>
<ul>
<li>我们需要选择一个支持外部化配置的框架。</li>
</ul>
<h3 id="何时使用外部化配置">何时使用外部化配置</h3>
<ul>
<li>任何重要的生产应用程序都必须使用外部化配置。</li>
</ul>
<h3 id="何时不宜使用外部化配置">何时不宜使用外部化配置</h3>
<ul>
<li>在验证概念的开发中。</li>
</ul>
<h3 id="可用技术示例-9">可用技术示例</h3>
<ul>
<li>几乎所有企业级的现代框架都支持外部化配置。</li>
</ul>
<h2 id="消费端驱动的契约测试">消费端驱动的契约测试</h2>
<p>在微服务架构中，通常有许多有不同团队开发的微服务。这些微型服务协同工作来满足业务需求（例如，客户请求），并相互进行同步或异步通信。消费端微服务的集成测试具有挑战性，通常用 TestDouble 以获得更快、更低成本的测试运行。但是 TestDouble 通常并不能代表真正的微服务提供者，而且如果微服务提供者更改了它的 API 或 消息，那么 TestDouble 将无法确认这些。另一种选择是进行端到端测试，尽管它在生产之前是强制性的，但却是脆弱的、缓慢的、昂贵的且不能替代集成测试（Test Pyramid）。</p>
<p>在这方面消费端驱动的契约测试可以帮助我们。在这里，负责消费端微服务的团队针对特定的服务端微服务，编写一套包含了其请求和预期响应（同步）或消息（异步）的测试套件，这些测试套件称为显式的约定。对于微服务服务端，将其消费端所有约定的测试套件都添加到其自动化测试中。当特定服务端微服务的自动化测试执行时，它将一起运行自己的测试和约定的测试并进行验证。通过这种方式，契约测试可以自动的帮助维护微服务通信的完整性。</p>
<h3 id="优点-10">优点</h3>
<ul>
<li>如果提供程序意外更改 API 或消息，可以被快速的自动发现。</li>
<li>更少意外、更健壮，特别是包含大量微服务的企业应用程序。</li>
<li>改善团队自主性。</li>
</ul>
<h3 id="缺点-10">缺点</h3>
<ul>
<li>需要额外的工作来开发和集成微服务服务端的契约测试，因为他们可能使用完全不同的测试工具。</li>
<li>如果契约测试与真实服务情况不匹配，将可能导致生产故障。</li>
</ul>
<h3 id="何时使用需求驱动的契约测试">何时使用需求驱动的契约测试</h3>
<ul>
<li>在大型企业业务应用程序中，通常由不同的团队开发不同服务。</li>
</ul>
<h3 id="何时不宜使用消费端驱动的契约测试">何时不宜使用消费端驱动的契约测试</h3>
<ul>
<li>所有微服务由同一团队负责开发的小型简单的应用程序。</li>
<li>如果服务端微服务是相对稳定的，并且不处在活跃的开发状态。</li>
</ul>
<h3 id="可用技术示例-10">可用技术示例</h3>
<ul>
<li>Pact， Postman， Spring Cloud Contract</li>
</ul>
<h1>总结</h1>
<p>在现代大规模企业软件开发中，微服务架构能够帮助开发扩展规模并带来很多长期收益。但是微服务架构并不是随处可用的银弹，如果应用在错误的应用程序类型，微服务架构将弊大于利。希望采用微服务架构的开发团队应该遵循最佳实践，并使用一系列可重用的、久经锤炼的设计模式。</p>
<p>微服务架构中至关重要的设计模式是独享数据库。实现这种设计模式具有挑战性，需要其他几种密切相关的设计模式（事件驱动、 CQRS、 Saga）来支持。在具有多个客户端（Web、 Mobile、 Desktop、 Smart Devices）的典型业务应用程序中，客户端和微服务之间的通信量可能是很大的，并且需要统一的安全控制，在这种情况面向前端的后端和 API 网关的设计非常有用。</p>
<p>此外，断路器模式可以大大地帮助应对这类应用程序的错误处理场景。迁移遗留的单体应用到微服务是极具挑战性的，而 Strangler 模式可以帮助做到这点。消费端驱动的契约测试是微服务集成测试的基础模式。另外外部化配置是任何现代化应用程序开发中的一种必备模式。</p>
<p>这个系列并不全面，在实际情况中您可能需要其他的设计模式，但这个系列能为您提供一个关于微服务架构设计模式的极好介绍。</p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/ChatGPT提示词原则/" data-toggle="tooltip" data-placement="top" title="ChatGPT提示词原则">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/使用PHP做图片防盗链/" data-toggle="tooltip" data-placement="top" title="使用PHP做图片防盗链">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      如果您喜欢此博客或发现它对您有用，则欢迎对此发表评论。 也欢迎您共享此博客，以便更多人可以参与。 如果博客中使用的图像侵犯了您的版权，请与作者联系以将其删除。 谢谢 ！
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=微服务架构中10个常用的设计模式&body=Hi,I found this website and thought you might like it http://yoursite-url/微服务架构中10个常用的设计模式/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <script src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: '',
      clientSecret: '',
      repo: '',
      owner: '',
      admin: '',
      id: 'Sat Apr 29 2023 16:09:41 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'en',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">目录</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">微服务架构</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E9%87%8D%E8%A6%81%E7%89%B9%E5%BE%81"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">微服务架构的重要特征</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E4%BC%98%E7%82%B9"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">微服务架构的优点</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">微服务架构的缺点</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">何时使用微服务架构</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">微服务架构的设计模式</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%8B%AC%E4%BA%AB%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%88Database-per-Microservice%EF%BC%89"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">独享数据库（Database per Microservice）</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BC%98%E7%82%B9"><span class="toc-nav-number">2.1.1.</span> <span class="toc-nav-text">优点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%BC%BA%E7%82%B9"><span class="toc-nav-number">2.1.2.</span> <span class="toc-nav-text">缺点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8%E7%8B%AC%E4%BA%AB%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-nav-number">2.1.3.</span> <span class="toc-nav-text">何时使用独享数据库</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%B8%8D%E5%AE%9C%E4%BD%BF%E7%94%A8%E7%8B%AC%E4%BA%AB%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-nav-number">2.1.4.</span> <span class="toc-nav-text">何时不宜使用独享数据库</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%8F%AF%E7%94%A8%E6%8A%80%E6%9C%AF%E7%A4%BA%E4%BE%8B"><span class="toc-nav-number">2.1.5.</span> <span class="toc-nav-text">可用技术示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%BA%8B%E4%BB%B6%E6%BA%90%EF%BC%88Event-Sourcing%EF%BC%89"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">事件源（Event Sourcing）</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BC%98%E7%82%B9-2"><span class="toc-nav-number">2.2.1.</span> <span class="toc-nav-text">优点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%BC%BA%E7%82%B9-2"><span class="toc-nav-number">2.2.2.</span> <span class="toc-nav-text">缺点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8%E4%BA%8B%E4%BB%B6%E6%BA%90"><span class="toc-nav-number">2.2.3.</span> <span class="toc-nav-text">何时使用事件源</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%B8%8D%E5%AE%9C%E4%BD%BF%E7%94%A8%E4%BA%8B%E4%BB%B6%E6%BA%90"><span class="toc-nav-number">2.2.4.</span> <span class="toc-nav-text">何时不宜使用事件源</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%8F%AF%E7%94%A8%E6%8A%80%E6%9C%AF%E7%A4%BA%E4%BE%8B-2"><span class="toc-nav-number">2.2.5.</span> <span class="toc-nav-text">可用技术示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%91%BD%E4%BB%A4%E5%92%8C%E6%9F%A5%E8%AF%A2%E8%81%8C%E8%B4%A3%E5%88%86%E7%A6%BB%EF%BC%88CQRS%EF%BC%89"><span class="toc-nav-number">2.3.</span> <span class="toc-nav-text">命令和查询职责分离（CQRS）</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BC%98%E7%82%B9-3"><span class="toc-nav-number">2.3.1.</span> <span class="toc-nav-text">优点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%BC%BA%E7%82%B9-3"><span class="toc-nav-number">2.3.2.</span> <span class="toc-nav-text">缺点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8-CQRS"><span class="toc-nav-number">2.3.3.</span> <span class="toc-nav-text">何时使用 CQRS</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%B8%8D%E5%AE%9C%E4%BD%BF%E7%94%A8-CQRS"><span class="toc-nav-number">2.3.4.</span> <span class="toc-nav-text">何时不宜使用 CQRS</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%8F%AF%E7%94%A8%E6%8A%80%E6%9C%AF%E7%A4%BA%E4%BE%8B-3"><span class="toc-nav-number">2.3.5.</span> <span class="toc-nav-text">可用技术示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Saga"><span class="toc-nav-number">2.4.</span> <span class="toc-nav-text">Saga</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BC%98%E7%82%B9-4"><span class="toc-nav-number">2.4.1.</span> <span class="toc-nav-text">优点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%BC%BA%E7%82%B9-4"><span class="toc-nav-number">2.4.2.</span> <span class="toc-nav-text">缺点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8-Saga"><span class="toc-nav-number">2.4.3.</span> <span class="toc-nav-text">何时使用 Saga</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%B8%8D%E5%AE%9C%E4%BD%BF%E7%94%A8-Saga"><span class="toc-nav-number">2.4.4.</span> <span class="toc-nav-text">何时不宜使用 Saga</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%8F%AF%E7%94%A8%E6%8A%80%E6%9C%AF%E7%A4%BA%E4%BE%8B-4"><span class="toc-nav-number">2.4.5.</span> <span class="toc-nav-text">可用技术示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E9%9D%A2%E5%90%91%E5%89%8D%E7%AB%AF%E7%9A%84%E5%90%8E%E7%AB%AF-%EF%BC%88BFF%EF%BC%89"><span class="toc-nav-number">2.5.</span> <span class="toc-nav-text">面向前端的后端 （BFF）</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BC%98%E7%82%B9-5"><span class="toc-nav-number">2.5.1.</span> <span class="toc-nav-text">优点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%BC%BA%E7%82%B9-5"><span class="toc-nav-number">2.5.2.</span> <span class="toc-nav-text">缺点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8-BFF"><span class="toc-nav-number">2.5.3.</span> <span class="toc-nav-text">何时使用 BFF</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%B8%8D%E5%AE%9C%E4%BD%BF%E7%94%A8-BFF"><span class="toc-nav-number">2.5.4.</span> <span class="toc-nav-text">何时不宜使用 BFF</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%8F%AF%E7%94%A8%E6%8A%80%E6%9C%AF%E7%A4%BA%E4%BE%8B-5"><span class="toc-nav-number">2.5.5.</span> <span class="toc-nav-text">可用技术示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#API-%E7%BD%91%E5%85%B3"><span class="toc-nav-number">2.6.</span> <span class="toc-nav-text">API 网关</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BC%98%E7%82%B9-6"><span class="toc-nav-number">2.6.1.</span> <span class="toc-nav-text">优点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%BC%BA%E7%82%B9-6"><span class="toc-nav-number">2.6.2.</span> <span class="toc-nav-text">缺点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8-API-%E7%BD%91%E5%85%B3"><span class="toc-nav-number">2.6.3.</span> <span class="toc-nav-text">何时使用 API 网关</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%B8%8D%E5%AE%9C%E4%BD%BF%E7%94%A8-API-%E7%BD%91%E5%85%B3"><span class="toc-nav-number">2.6.4.</span> <span class="toc-nav-text">何时不宜使用 API 网关</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%8F%AF%E7%94%A8%E6%8A%80%E6%9C%AF%E7%A4%BA%E4%BE%8B-6"><span class="toc-nav-number">2.6.5.</span> <span class="toc-nav-text">可用技术示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Strangler"><span class="toc-nav-number">2.7.</span> <span class="toc-nav-text">Strangler</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BC%98%E7%82%B9-7"><span class="toc-nav-number">2.7.1.</span> <span class="toc-nav-text">优点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%BC%BA%E7%82%B9-7"><span class="toc-nav-number">2.7.2.</span> <span class="toc-nav-text">缺点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8-Strangler"><span class="toc-nav-number">2.7.3.</span> <span class="toc-nav-text">何时使用 Strangler</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%8F%AF%E7%94%A8%E6%8A%80%E6%9C%AF%E7%A4%BA%E4%BE%8B-7"><span class="toc-nav-number">2.7.4.</span> <span class="toc-nav-text">可用技术示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%96%AD%E8%B7%AF%E5%99%A8"><span class="toc-nav-number">2.8.</span> <span class="toc-nav-text">断路器</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BC%98%E7%82%B9-8"><span class="toc-nav-number">2.8.1.</span> <span class="toc-nav-text">优点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%BC%BA%E7%82%B9-8"><span class="toc-nav-number">2.8.2.</span> <span class="toc-nav-text">缺点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8%E6%96%AD%E8%B7%AF%E5%99%A8"><span class="toc-nav-number">2.8.3.</span> <span class="toc-nav-text">何时使用断路器</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%B8%8D%E5%AE%9C%E4%BD%BF%E7%94%A8%E6%96%AD%E8%B7%AF%E5%99%A8"><span class="toc-nav-number">2.8.4.</span> <span class="toc-nav-text">何时不宜使用断路器</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%8F%AF%E7%94%A8%E6%8A%80%E6%9C%AF%E7%A4%BA%E4%BE%8B-8"><span class="toc-nav-number">2.8.5.</span> <span class="toc-nav-text">可用技术示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%A4%96%E9%83%A8%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-nav-number">2.9.</span> <span class="toc-nav-text">外部化配置</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BC%98%E7%82%B9-9"><span class="toc-nav-number">2.9.1.</span> <span class="toc-nav-text">优点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%BC%BA%E7%82%B9-9"><span class="toc-nav-number">2.9.2.</span> <span class="toc-nav-text">缺点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8%E5%A4%96%E9%83%A8%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-nav-number">2.9.3.</span> <span class="toc-nav-text">何时使用外部化配置</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%B8%8D%E5%AE%9C%E4%BD%BF%E7%94%A8%E5%A4%96%E9%83%A8%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-nav-number">2.9.4.</span> <span class="toc-nav-text">何时不宜使用外部化配置</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%8F%AF%E7%94%A8%E6%8A%80%E6%9C%AF%E7%A4%BA%E4%BE%8B-9"><span class="toc-nav-number">2.9.5.</span> <span class="toc-nav-text">可用技术示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%B6%88%E8%B4%B9%E7%AB%AF%E9%A9%B1%E5%8A%A8%E7%9A%84%E5%A5%91%E7%BA%A6%E6%B5%8B%E8%AF%95"><span class="toc-nav-number">2.10.</span> <span class="toc-nav-text">消费端驱动的契约测试</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BC%98%E7%82%B9-10"><span class="toc-nav-number">2.10.1.</span> <span class="toc-nav-text">优点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%BC%BA%E7%82%B9-10"><span class="toc-nav-number">2.10.2.</span> <span class="toc-nav-text">缺点</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%BD%BF%E7%94%A8%E9%9C%80%E6%B1%82%E9%A9%B1%E5%8A%A8%E7%9A%84%E5%A5%91%E7%BA%A6%E6%B5%8B%E8%AF%95"><span class="toc-nav-number">2.10.3.</span> <span class="toc-nav-text">何时使用需求驱动的契约测试</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%95%E6%97%B6%E4%B8%8D%E5%AE%9C%E4%BD%BF%E7%94%A8%E6%B6%88%E8%B4%B9%E7%AB%AF%E9%A9%B1%E5%8A%A8%E7%9A%84%E5%A5%91%E7%BA%A6%E6%B5%8B%E8%AF%95"><span class="toc-nav-number">2.10.4.</span> <span class="toc-nav-text">何时不宜使用消费端驱动的契约测试</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%8F%AF%E7%94%A8%E6%8A%80%E6%9C%AF%E7%A4%BA%E4%BE%8B-10"><span class="toc-nav-number">2.10.5.</span> <span class="toc-nav-text">可用技术示例</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">总结</span></a></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">特色标签</a>
          </h5>
          <div class="tags">
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>链友</h5>
        <ul class="list-inline">

          
          <li>
            <a href="https://v-vincen.life/" target="_blank">V_Vincen</a>
          </li>
          
          <li>
            <a href="http://beantech.org" target="_blank">Bean Tech</a>
          </li>
          
          <li>
            <a href="http://huangxuan.me" target="_blank">Hux Blog</a>
          </li>
          
          <li>
            <a href="https://hexo.io/" target="_blank">Hexo</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          Chase Shen
          2024
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/js/jquery.min.js"></script>

  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/js/bootstrap.min.js"></script>

  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/js/hux-blog.min.js"></script>

  <!-- catalog -->
  <script async="true" type="text/javascript" src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/js/catalog.js"></script>

  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/js/scroll.js"></script>
    <!-- Scroll end -->
  

  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/js/mouseclick.js"  content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033' ></script>
    <!-- Mouseclick -->
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/js/ribbonDynamic.js"></script>
  

  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("http://yoursite-url/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="搜索..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            
              imgUrl = 'https://cdn.jsdelivr.net/gh/chaseshc/JSDelivr' + imgUrl;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
